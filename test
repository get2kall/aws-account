import os
import pymysql.cursors
from atlassian import Confluence

# Connect to your database
def get_data_from_db():
    host = os.environ['RDS_HOST']
    user = os.environ['RDS_USER']
    password = os.environ['RDS_PASSWORD']
    database = 'mydatabase'

    connection = pymysql.connect(
        host=host,
        user=user,
        password=password,
        database=database,
        cursorclass=pymysql.cursors.DictCursor
    )

    try:
        with connection.cursor() as cursor:
            cursor.execute("SELECT * FROM result_data ORDER BY timestamp DESC;")
            result = cursor.fetchall()
            return result
    finally:
        connection.close()


# Convert your data to html
def convert_data_to_html(data):
    html = "<table>"
    for row in data:
        html += "<tr>"
        for key, value in row.items():
            html += "<td>" + str(value) + "</td>"
        html += "</tr>"
    html += "</table>"
    return html


# Push the data to Confluence
def push_data_to_confluence(html_data, page_id):
    confluence_url = 'https://your-confluence-url'
    confluence_username = os.environ['CONFLUENCE_USERNAME']  # Retrieve the username from the secret
    confluence_password = os.environ['CONFLUENCE_PASSWORD']  # Retrieve the password from the secret

    confluence = Confluence(
        url=confluence_url,
        username=confluence_username,
        password=confluence_password
    )

    title = 'your-page-title'
    body = html_data

    confluence.update_page(
        page_id=page_id,
        title=title,
        body=body,
        type='page',
        representation='storage'
    )


if __name__ == "__main__":
    data = get_data_from_db()
    html_data = convert_data_to_html(data)
    page_id = 'your-page-id'  # Update with the desired page ID
    push_data_to_confluence(html_data, page_id)
