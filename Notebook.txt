import os
import json

# Read non-empty lines from images.txt into a list
with open('images.txt', 'r') as f:
    lines = f.read().splitlines()

# Filter out empty lines
lines = [line for line in lines if line.strip()]

# Process lines
matrix = []
for line in lines:
    split_line = line.split(':')
    
    # Default to 'latest' version if not specified
    if len(split_line) < 2:
        split_line.append('latest')
    
    split_image = split_line[0].split('/')
    
    # Default to 'docker.io' registry if not specified
    if len(split_image) < 2:
        split_image.insert(0, 'docker.io')
    
    matrix.append({
        "registry": split_image[0],
        "image": "/".join(split_image[1:]),
        "version": split_line[1]
    })

# Print JSON matrix
json_matrix = json.dumps(matrix)

# Set environment variable for use in subsequent steps
with open(os.getenv('GITHUB_ENV'), 'a') as f:
    f.write(f"matrix={json_matrix}\n")
