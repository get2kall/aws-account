name: Docker Image Processing

on:
  push:
    branches:
      - main

jobs:
  prepare_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Set up JQ
      uses: chris48s/setup-jq-action@v1.0.0

    - name: Compute matrix
      id: set-matrix
      run: |
        content=$(cat images.txt)
        json_content=$(jq -R -s -c 'split("\n")[:-1] | map({image: .})' <<< "$content")
        echo "::set-output name=matrix::$json_content"

  process-images:
    needs: prepare_matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{fromJson(needs.prepare_matrix.outputs.matrix)}}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Docker
      uses: docker/setup-docker-buildx-action@v1

    - name: Setup Snyk
      uses: snyk/actions/setup@master
      with:
        token: ${{ secrets.SNYK_TOKEN }}

    - name: Run Script for Each Image
      run: |
        ./your-shell-script.sh ${{ matrix.image }}
