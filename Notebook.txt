name: Daily Image Update

on:
  push:

jobs:
  prepare_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Generate matrix
      id: set-matrix
      run: |
        content=$(cat images.txt)
        json_content=$(jq -R -s -c 'split("\n")[:-1] | map(split(":")) | map({image: .[0], version: .[1]})' <<< "$content")
        echo "::set-output name=matrix::$json_content"

  update_images:
    needs: prepare_matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.prepare_matrix.outputs.matrix)}}

    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
      ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
      ARTIFACTORY_URL: ${{ secrets.ARTIFACTORY_URL }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Login to Artifactory
      uses: docker/login-action@v1
      with:
        registry: ${{ env.ARTIFACTORY_URL }}
        username: ${{ env.ARTIFACTORY_USERNAME }}
        password: ${{ env.ARTIFACTORY_PASSWORD }}

    - name: Install JQ
      run: sudo apt-get install jq

    - name: Run Shell Script
      run: |
        chmod +x docker_scan.sh
        ./docker_scan.sh ${{ matrix.image }}:${{ matrix.version }}
        
    - name: Push Images with Normal Vulnerability
      run: |
        image=${{ matrix.image }}
        version=${{ matrix.version }}
        snyk_report=$(cat snyk-result.json)
        snyk_issues=$(echo "$snyk_report" | jq '.issues')
        snyk_vulnerabilities=$(echo "$snyk_report" | jq '.vulnerabilities')

        if [ -z "$snyk_vulnerabilities" ]; then
          echo "No vulnerabilities found in $image:$version"
          docker tag $image:$version $ARTIFACTORY_URL/docker/$image:$version
          docker push $ARTIFACTORY_URL/docker/$image:$version
        else
          echo "Vulnerabilities found in $image:$version"
          echo "$snyk_issues"
        fi
