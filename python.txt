import os
import sys
import glob
import csv
import pymysql.cursors

def insert_data(registry, image, version, scan_tool, status):
    # Database connection details
    host = os.environ['RDS_HOST']
    user = os.environ['RDS_USER']
    password = os.environ['RDS_PASSWORD']
    database = 'mydatabase'  # hardcoded database name

    # Establish database connection
    connection = pymysql.connect(
        host=host,
        user=user,
        password=password,
        cursorclass=pymysql.cursors.DictCursor
    )

    try:
        with connection.cursor() as cursor:
            cursor.execute("CREATE DATABASE IF NOT EXISTS {};".format(database))
            cursor.execute("USE {};".format(database))
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS result_data (
                    registry VARCHAR(255),
                    image VARCHAR(255),
                    version VARCHAR(255),
                    scan_tool VARCHAR(255),
                    status VARCHAR(255),
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            """)
            print(f"Inserting: registry={registry}, image={image}, version={version}, scan_tool={scan_tool}, status={status}")
            sql = "INSERT INTO result_data (registry, image, version, scan_tool, timestamp, status) VALUES (%s, %s, %s, %s, NOW(), %s)"
            cursor.execute(sql, (registry, image, version, scan_tool, status))
        connection.commit()
    except Exception as e:
        print(f"Error inserting data: {e}")
    finally:
        connection.close()

def fetch_data():
    # Database connection details
    host = os.environ['RDS_HOST']
    user = os.environ['RDS_USER']
    password = os.environ['RDS_PASSWORD']
    database = 'mydatabase'

    # Establish database connection
    connection = pymysql.connect(
        host=host,
        user=user,
        password=password,
        cursorclass=pymysql.cursors.DictCursor
    )

    try:
        with connection.cursor() as cursor:
            cursor.execute("USE {};".format(database))
            cursor.execute("SELECT * FROM result_data ORDER BY timestamp DESC;")
            result = cursor.fetchall()
            for row in result:
                print(row)
    finally:
        connection.close()

if __name__ == "__main__":
    for filename in glob.glob('result-*.txt'):
        image_name = filename.split('-')[-1].replace('.txt', '')
        with open(filename, 'r') as f:
            reader = csv.reader(f)
            for row in reader:
                print(f"Processing row: {row}")
                if len(row) >= 4:
                    registry = row[0]
                    image_info = row[1].rsplit(":", maxsplit=1)
                    image_name = image_info[0]
                    version = row[2] if len(row) > 2 else ""  # change this line
                    scan_tool = image_info[1] if len(image_info) == 2 else ""  # change this line
                    status = row[3] if len(row) > 3 else ""  # change this line
                    insert_data(registry, image_name, version, scan_tool, status)
                else:
                    print(f'Invalid row in {filename}: {row}', file=sys.stderr)
    fetch_data()
